{% extends "base.html" %}
{% block conteudo %}

<h3>Solicitações Pendentes</h3>

<table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>Espaço</th>
            <th>Setor</th>
            <th>Horário</th>
            <th>Solicitante</th>
            <th>Motivo</th>
            <th style="width: 180px;">Ações</th>
        </tr>
    </thead>

    <tbody>
    {% for ag in pendentes %}
        <tr>
            <td>{{ ag.espaco.nome }}</td>
            <td>{{ ag.espaco.setor.nome }}</td>
            <td>{{ ag.inicio.strftime('%d/%m %H:%M') }} - {{ ag.fim.strftime('%H:%M') }}</td>
            <td>{{ ag.usuario.nome }}</td>
            <td>{{ ag.motivo }}</td>
            <td>
                <button type="button"
                        class="btn btn-success btn-sm"
                        onclick="verificarAntesDeAceitar({{ ag.id }})">
                    Aprovar
                </button>

                <a href="/agendamentos/{{ ag.id }}/recusar" class="btn btn-danger btn-sm">
                    Recusar
                </a>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<!-- MODAL  -->

<style>

#modalConflitos {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.55);
    backdrop-filter: blur(4px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    animation: fadeBg .3s ease-in-out;
}

@keyframes fadeBg {
    from { opacity: 0; }
    to   { opacity: 1; }
}

.modal-card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    width: 650px;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 0 20px rgba(0,0,0,.3);
    animation: zoomIn .25s ease-in-out;
}

@keyframes zoomIn {
    from { transform: scale(.85); opacity: 0; }
    to   { transform: scale(1); opacity: 1; }
}

.table-danger { background-color: #f8d7da !important; }
.table-warning { background-color: #fff3cd !important; }

</style>


<div id="modalConflitos">
    <div class="modal-card">

        <h4 class="mb-3">Conflitos Encontrados</h4>

        <p><b>Agendamento a ser aprovado:</b></p>

        <div class="mb-3 p-2 border rounded bg-light">
            <b>Setor:</b> <span id="conf_setor"></span><br>
            <b>Espaço:</b> <span id="conf_espaco"></span><br>
            <b>Horário:</b> <span id="conf_horario"></span><br>
            <b>Solicitante:</b> <span id="conf_usuario"></span><br>
            <b>Motivo:</b> <span id="conf_motivo"></span><br>
        </div>

        <h5>Eventos Conflitantes</h5>

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Setor</th>
                    <th>Espaço</th>
                    <th>Horário</th>
                    <th>Usuário</th>
                    <th>Motivo</th>
                </tr>
            </thead>
            <tbody id="conf_tabela"></tbody>
        </table>

        <label class="mt-3">Justificativa (obrigatória):</label>
        <textarea id="conf_justificativa"
                  class="form-control mb-3"
                  placeholder="Explique o motivo da decisão..."
                  required>
        </textarea>

        <div class="text-end">
            <button class="btn btn-success" id="btnAceitarConflito">Aceitar Mesmo Assim</button>
            <button class="btn btn-secondary" onclick="fecharConflito()">Cancelar</button>
        </div>

    </div>
</div>



<!-- SCRIPT  -->

<script>

async function verificarAntesDeAceitar(id) {

    // buscar conflitos
    let r = await fetch(`/api/conflitos_aceitar/${id}`);
    let conflitos = await r.json();

    // buscar dados do próprio agendamento
    let rr = await fetch(`/api/agendamento/${id}`);
    let alvo = await rr.json();

    // preencher a modal
    document.getElementById("conf_setor").innerText = alvo.setor;
    document.getElementById("conf_espaco").innerText = alvo.espaco;
    document.getElementById("conf_horario").innerText = `${alvo.inicio} - ${alvo.fim}`;
    document.getElementById("conf_usuario").innerText = alvo.usuario;
    document.getElementById("conf_motivo").innerText = alvo.motivo || "Não informado";

    let tbody = document.getElementById("conf_tabela");
    tbody.innerHTML = "";

    conflitos.forEach(c => {
        tbody.innerHTML += `
            <tr class="${c.status === 'APROVADO' ? 'table-danger' : 'table-warning'}">
                <td>${c.status}</td>
                <td>${c.setor}</td>
                <td>${c.espaco}</td>
                <td>${c.inicio} - ${c.fim}</td>
                <td>${c.usuario}</td>
                <td>${c.motivo || "Não informado"}</td>
            </tr>
        `;
    });

    // salvar contexto global
    window.confirma_id = id;
    window.confirma_lista = conflitos;

    abrirConflito();
}

function abrirConflito() {
    document.getElementById("modalConflitos").style.display = "flex";
}

function fecharConflito() {
    document.getElementById("modalConflitos").style.display = "none";
}

document.getElementById("btnAceitarConflito").addEventListener("click", async () => {

    let justificativa = document.getElementById("conf_justificativa").value.trim();

    if (!justificativa) {
        alert("Justificativa obrigatória!");
        return;
    }

    // aprovar o agendamento alvo
    await fetch(`/agendamentos/aceitar/${window.confirma_id}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ justificativa })
    });

    // recusar automaticamente os conflitantes
    for (let c of window.confirma_lista) {
        await fetch(`/agendamentos/recusar/${c.id}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ justificativa })
        });
    }

    location.reload();
});

</script>

{% endblock %}
